<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p>As a little boy, I dreamed of becoming a supersonic jet pilot or an astronaut. I also yearned to pilot trains, subways, trolleybuses, trams, and other vessels. I remember stealing pot lids from my grandparent's kitchen to make a steering wheel. And also all sorts of devices and tools to emulate the cockpit dashboard. My childish mind easily turned a hammer into a landing gear release lever. Clothes pegs quickly served as switches to open the airlocks.</p> <p>That could be one of the reasons why I have fun times being the <a href="https://pgwatch.com/" target="_blank" rel="noopener">pgwatch</a> maintainer. After all, one of the duties is to maintain <a href="https://demo.pgwatch.com" target="_blank" rel="noopener">Grafana dashboards</a>, which are widely used for monitoring and visualization. Today, I want to introduce <a href="https://github.com/cybertec-postgresql/pg_timetable/blob/master/extras/grafana_status_overview.json" target="_blank" rel="noopener">an updated dashboard</a> to monitor <a href="https://github.com/cybertec-postgresql/pg_timetable" target="_blank" rel="noopener">pg_timetable</a> scheduled jobs.</p> <p><a href="/wp-content/uploads/2024/02/grafana_pg_timetable_dashboard.png"><img decoding="async" class="aligncenter wp-image-50544 size-full" src="/wp-content/uploads/2024/02/grafana_pg_timetable_dashboard-1024x787.png" alt="Grafana dashboard to monitor pg_timetable jobs" width="640" height="492"></a></p> <h2>Grafana dashboard overview</h2> <p>Let me describe all the elements on this dashboard.</p> <h3>Client name</h3> <p><img decoding="async" class="aligncenter size-full wp-image-50553" src="/wp-content/uploads/2024/02/grafana_pg_timetable_select_client_name-1.png" alt="Select client name in Grafana dashboard for pg_timetable" width="372" height="299"></p> <p>The <strong>"Client name"</strong> drop-down list allows you to filter data only for selected pg_timetable clients. By default, all client sessions are displayed.</p> <h3>Schedulers running</h3> <p><img decoding="async" class="aligncenter size-full wp-image-50560" src="/wp-content/uploads/2024/02/grafana_pg_timetable_scheduler_is_not_running.jpg" alt="" width="2172" height="233"></p> <p>The <strong>"Schedulers running"</strong> panel indicates in "real-time" how many pg_timetable instances are running and connected to the current database. This panel is an excellent choice <a href="https://grafana.com/docs/grafana/latest/alerting/set-up/" target="_blank" rel="noopener">to create an alert</a> based on it. If you prefer the direct query, then use this one:</p> <p></p> <pre class="urvanov-syntax-highlighter-plain-tag">SELECT
  count(DISTINCT client_name)
from
  timetable.active_session</pre> <p></p> <h3>Total chains vs Enabled chains</h3> <p>The <strong>"Total chains"</strong> panel shows you how many chain definitions are available in the system, including paused. One can get this value simply by executing:</p> <p></p> <pre class="urvanov-syntax-highlighter-plain-tag">SELECT
   count(*)
FROM
  timetable.chain</pre> <p></p> <p>On the contrary, the <strong>"Enabled chains"</strong> panel displays how many jobs the client can execute. If the "Client name" value is "All," this panel indicates the total number of all non-paused chains. This query allows you to get such a piece of information directly:</p> <p></p> <pre class="urvanov-syntax-highlighter-plain-tag">SELECT
  count(*)
FROM
  timetable.chain
WHERE
  live AND client_name ISNULL or client_name IN ('bill', 'scheduler')</pre> <p></p> <p>Please note that if <code>client_name</code> is null here, all running schedulers can execute such a chain.</p> <p>All following panels are affected by the <strong>"Client name"</strong> and the time interval selected in the top bar, e.g., "Last 1 hour".</p> <h3>Total task executions</h3> <p>The <strong>"Total task executions"</strong> panel represents the number of tasks executed by the specified client(s) during the selected time frame. Pay attention; we are talking about tasks here, not chains. We want such a granularity here because some chains may consist of several tasks. To get this value directly, one can run such a query:</p> <p></p> <pre class="urvanov-syntax-highlighter-plain-tag">SELECT
  count(*)
FROM
  timetable.execution_log
WHERE
  last_run BETWEEN '2024-01-18T10:10:00Z' AND '2024-01-18T11:30:00Z' and client_name in ('bill','scheduler')</pre> <p></p> <p>We examine <code>timetable.execution_log</code> here. That means the <code>client_name</code> column will definitely indicate the runner. The <code>last_run</code> column holds the start time of a task. If you're looking for the time when a task was finished, use a corresponding <code>finished</code> column.</p> <h3>Total task errors</h3> <p>The <strong>"Total task errors"</strong> panel shows how many tasks the selected client(s) failed during the time frame chosen. This number, however, doesn't include failures of tasks with the <code>timetable.task.ignore_error</code> column set to true. Remember to tune the panel thresholds. By default, 0 (no errors) is shown as green, 1-10 errors are colored orange, and more than that are painted red.<br> To get this information directly, use such the query:</p> <p></p> <pre class="urvanov-syntax-highlighter-plain-tag">SELECT
  count(*)
FROM
  timetable.execution_log
WHERE
  last_run BETWEEN '2024-01-18T10:10:00Z' AND '2024-01-18T11:30:00Z'
  AND returncode != 0 
  AND NOT COALESCE(ignore_error, false) 
  AND client_name in ('bill', 'scheduler')</pre> <p></p> <h3>Average task duration</h3> <p>The <strong>"Average task duration"</strong> panel displays the average duration of successful tasks during the selected interval. There are no predefined thresholds set for this panel. You should probably apply some based on your specific workflows. To collect this value, we use the query like this:</p> <p></p> <pre class="urvanov-syntax-highlighter-plain-tag">SELECT
  avg(finished - last_run)
FROM
  timetable.execution_log
WHERE
  last_run BETWEEN '2024-01-18T10:10:00Z' AND '2024-01-18T11:30:00Z'
  AND returncode = 0
  AND client_name in ('bill', 'scheduler')</pre> <p></p> <p>The <strong>"Task executions (total vs error)"</strong> graph provides detailed execution information for the selected time interval. The visualization consists of bars indicating a heartbeat of the pg_timetable equal to 1 minute. For example, from <a href="/wp-content/uploads/2024/02/grafana_pg_timetable_dashboard.png" target="_blank" rel="noopener">the graph provided above</a>, we can tell:</p> <ol> <li>We have no information about the system before 11:23. Either logs were truncated at that time, or the system was initialized at this time.</li> <li>From 11:23 till 12:00, the schedulers were producing nearly 500 task executions each minute (green line), and roughly half of the executions returned ignored (silenced) errors (blue line).</li> <li>There were 102 non-ignored errors in total, according to the "Total task error" panel. However, we cannot observe it on the graph (red line) due to the scale.</li> </ol> <p>If you want to examine these trends in your favorite SQL client, start with such code snippet:</p> <p></p> <pre class="urvanov-syntax-highlighter-plain-tag">SELECT
  date_trunc('minute', finished) as time,
  count(*) as total,
  count(*) FILTER (WHERE returncode != 0 AND NOT COALESCE(ignore_error, false)) as errors,
  count(*) FILTER (WHERE returncode != 0 AND ignore_error) as 'ignored errors'
FROM
  timetable.execution_log
WHERE
  finished BETWEEN '2024-01-18T10:10:00Z' AND '2024-01-18T11:30:00Z'    
  AND client_name in ('bill', 'scheduler') 
GROUP by 1</pre> <p></p> <p>The bottom last <strong>"Task executions errors"</strong> grid lets you see all non-ignored task errors for the selected interval. This grid is a detailed view of the previously discussed <strong>"Total task errors"</strong> panel.</p> <h2>Finally...</h2> <p>If you want to contribute to <strong>pg_timetable</strong> and help to make it better:</p> <ul> <li>‚≠ê<a href="https://github.com/cybertec-postgresql/pg_timetable/stargazers" rel="external nofollow noopener" target="_blank">give a star</a> to the project,</li> <li>feel free to open an ü§ö<a href="https://github.com/cybertec-postgresql/pg_timetable/issues" rel="external nofollow noopener" target="_blank">issue</a> and ask a üéì<a href="https://github.com/cybertec-postgresql/pg_timetable/discussions" target="_blank" rel="noopener">question</a> </li> <li>or even consider submitting a üìú<a href="https://github.com/cybertec-postgresql/pg_timetable/pulls" target="_blank" rel="noopener">pull request</a>.</li> </ul> <p>In conclusion, I wish you all the best! üíôüíõ<br> See you soon in person at one of the <a href="https://www.postgresql.org/about/events/" target="_blank" rel="noopener noreferrer">conferences</a>, meetups, or <a href="/en/training/" target="_blank" rel="noopener noreferrer">training sessions!</a></p> <p>The post <a href="https://www.cybertec-postgresql.com/en/grafana-dashboard-for-pg_timetable-scheduled-jobs/" rel="external nofollow noopener" target="_blank">Grafana dashboard for pg_timetable scheduled jobs</a> appeared first on <a href="https://www.cybertec-postgresql.com/en" rel="external nofollow noopener" target="_blank">CYBERTEC PostgreSQL | Services &amp; Support</a>.</p> </body></html>